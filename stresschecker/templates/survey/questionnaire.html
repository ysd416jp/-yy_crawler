{% extends "base.html" %}
{% block title %}ストレスチェック - 回答{% endblock %}
{% block body_class %}survey-page{% endblock %}

{% block content %}
<div class="survey-container py-3">
    <form method="POST" id="surveyForm">
        <!-- プログレスバー -->
        <div class="sticky-top bg-white py-2 border-bottom mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-muted">回答の進捗</small>
                <small class="text-muted"><span id="answeredCount">0</span> / 57</small>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        {% set current_group = namespace(value='') %}
        {% set current_subtext = namespace(value='') %}

        {% for q in questions %}
            {# 群が変わったらヘッダーを表示 #}
            {% if q.group != current_group.value %}
                {% set current_group.value = q.group %}
                {% set current_subtext.value = '' %}
                <div class="group-header mt-4 mb-3">
                    <h4 class="group-title">{{ group_headers[q.group].title }}</h4>
                    <p class="text-muted">{{ group_headers[q.group].instruction }}</p>
                </div>
            {% endif %}

            {# C群のサブテキストが変わったら表示 #}
            {% if q.get('subtext') and q.subtext != current_subtext.value %}
                {% set current_subtext.value = q.subtext %}
                <div class="subtext-header mt-3 mb-2">
                    <p class="fw-bold text-secondary">{{ q.subtext }}</p>
                </div>
            {% endif %}

            <div class="question-card mb-2" id="qcard_{{ q.number }}">
                <div class="question-number">Q{{ q.number }}</div>
                <div class="question-text">{{ q.text }}</div>
                <div class="choices-row">
                    {% set choices = choice_sets[q.choices] %}
                    {% for c in choices %}
                    <label class="choice-label">
                        <input type="radio"
                               name="q{{ q.number }}"
                               value="{{ c.value }}"
                               {% if answers.get(q.number) == c.value %}checked{% endif %}
                               onchange="updateProgress()">
                        <span class="choice-btn">{{ c.label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

        <div class="text-center py-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                回答を送信する
            </button>
            <p class="text-muted small mt-2">すべての質問に回答してから送信してください</p>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateProgress() {
    const total = 57;
    const answered = document.querySelectorAll('input[type="radio"]:checked').length;
    document.getElementById('answeredCount').textContent = answered;
    document.getElementById('progressBar').style.width = (answered / total * 100) + '%';

    // 回答済みカードのスタイル変更
    for (let i = 1; i <= total; i++) {
        const card = document.getElementById('qcard_' + i);
        const checked = document.querySelector('input[name="q' + i + '"]:checked');
        if (checked) {
            card.classList.add('answered');
        }
    }
}

document.getElementById('surveyForm').addEventListener('submit', function(e) {
    const answered = document.querySelectorAll('input[type="radio"]:checked').length;
    if (answered < 57) {
        e.preventDefault();
        // 未回答の質問にスクロール
        for (let i = 1; i <= 57; i++) {
            const checked = document.querySelector('input[name="q' + i + '"]:checked');
            if (!checked) {
                const card = document.getElementById('qcard_' + i);
                card.classList.add('unanswered-highlight');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                break;
            }
        }
        alert('未回答の質問があります。すべての質問に回答してください。');
    }
});

// 初期状態を反映
updateProgress();
</script>
{% endblock %}
